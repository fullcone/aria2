name: build

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    steps:
    - uses: actions/checkout@v6

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          make binutils autoconf automake autotools-dev libtool \
          patch ca-certificates pkg-config git curl dpkg-dev \
          gcc-mingw-w64 g++-mingw-w64 autopoint libcppunit-dev \
          libxml2-dev libgcrypt20-dev lzip

    - name: Cache dependencies
      uses: actions/cache@v4
      id: cache-deps
      with:
        path: /usr/local/x86_64-w64-mingw32
        key: mingw-deps-x86_64-v3

    - name: Build zlib
      if: steps.cache-deps.outputs.cache-hit != 'true'
      run: |
        curl -L -O https://github.com/madler/zlib/releases/download/v1.3.1/zlib-1.3.1.tar.gz
        tar xf zlib-1.3.1.tar.gz
        cd zlib-1.3.1
        CC=x86_64-w64-mingw32-gcc AR=x86_64-w64-mingw32-ar LD=x86_64-w64-mingw32-ld \
          RANLIB=x86_64-w64-mingw32-ranlib STRIP=x86_64-w64-mingw32-strip \
          ./configure --prefix=/usr/local/x86_64-w64-mingw32 \
          --libdir=/usr/local/x86_64-w64-mingw32/lib \
          --includedir=/usr/local/x86_64-w64-mingw32/include --static
        make -j$(nproc)
        sudo make install

    - name: Build c-ares
      if: steps.cache-deps.outputs.cache-hit != 'true'
      run: |
        curl -L -O https://github.com/c-ares/c-ares/releases/download/cares-1_19_1/c-ares-1.19.1.tar.gz
        tar xf c-ares-1.19.1.tar.gz
        cd c-ares-1.19.1
        ./configure --disable-shared --enable-static --without-random \
          --prefix=/usr/local/x86_64-w64-mingw32 --host=x86_64-w64-mingw32 \
          --build=$(dpkg-architecture -qDEB_BUILD_GNU_TYPE) LIBS="-lws2_32"
        make -j$(nproc)
        sudo make install

    - name: Build expat
      if: steps.cache-deps.outputs.cache-hit != 'true'
      run: |
        curl -L -O https://github.com/libexpat/libexpat/releases/download/R_2_5_0/expat-2.5.0.tar.bz2
        tar xf expat-2.5.0.tar.bz2
        cd expat-2.5.0
        ./configure --disable-shared --enable-static \
          --prefix=/usr/local/x86_64-w64-mingw32 --host=x86_64-w64-mingw32 \
          --build=$(dpkg-architecture -qDEB_BUILD_GNU_TYPE)
        make -j$(nproc)
        sudo make install

    - name: Build sqlite
      if: steps.cache-deps.outputs.cache-hit != 'true'
      run: |
        curl -L -O https://www.sqlite.org/2023/sqlite-autoconf-3430100.tar.gz
        tar xf sqlite-autoconf-3430100.tar.gz
        cd sqlite-autoconf-3430100
        ./configure --disable-shared --enable-static \
          --prefix=/usr/local/x86_64-w64-mingw32 --host=x86_64-w64-mingw32 \
          --build=$(dpkg-architecture -qDEB_BUILD_GNU_TYPE)
        make -j$(nproc)
        sudo make install

    - name: Build aria2
      run: |
        autoreconf -i
        ./configure \
          --host=x86_64-w64-mingw32 \
          --prefix=/usr/local/x86_64-w64-mingw32 \
          --without-included-gettext \
          --disable-nls \
          --with-libcares \
          --without-gnutls \
          --without-openssl \
          --with-sqlite3 \
          --with-libexpat \
          --with-libz \
          --without-libxml2 \
          --without-libssh2 \
          --without-libgcrypt \
          --without-libnettle \
          ARIA2_STATIC=yes \
          CPPFLAGS="-I/usr/local/x86_64-w64-mingw32/include" \
          LDFLAGS="-L/usr/local/x86_64-w64-mingw32/lib" \
          PKG_CONFIG_PATH="/usr/local/x86_64-w64-mingw32/lib/pkgconfig"
        make -j$(nproc)
        x86_64-w64-mingw32-strip src/aria2c.exe

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: aria2c-windows-x86_64
        path: src/aria2c.exe
